import pickle
import sys
import json
import torch
from sbi import utils as utils
from sbi.inference import SNPE
from sbi.utils.get_nn_models import posterior_nn

from example_codes.sbi_generate_data import simulator


def main(argv):

    torch.set_num_threads(int(argv[1]))

    images = torch.load("images.pt")
    indices = torch.load("indices.pt")

    prior_indices = utils.BoxUniform(low=1 * torch.ones(1), high=20 * torch.ones(1))

    density_estimator_build_fun = posterior_nn(
        model="maf",
        hidden_features=training_params["HIDDEN_FEATURES"],
        num_transforms=training_params["NUM_TRANSFORMS"],
    )
    inference = SNPE(
        prior=prior_indices,
        density_estimator=density_estimator_build_fun,
        device=training_params["DEVICE"],
    )

    # Train multiple posteriors for different noise levels

    inference = inference.append_simulations(indices, images)

    density_estimator = inference.train()
    posterior = inference.build_posterior(density_estimator)

    with open(training_params["POSTERIOR_NAME"], "wb") as handle:
        pickle.dump(posterior, handle)


def check_inputs():

    for section in ["TRAINING"]:
        assert (
            section in config.keys()
        ), f"Please provide section {section} in config.ini"

    for key in ["HIDDEN_FEATURES", "NUM_TRANSFORMS", "DEVICE"]:
        assert key in training_params.keys(), f"Please provide a value for {key}"

    if "POSTERIOR_NAME" not in training_params.keys():
        training_params["POSTERIOR_NAME"] = "posterior.pkl"

    return


if __name__ == "__main__":

    global config, training_params

    config = json.load(open("config.json"))

    training_params = dict(config["TRAINING"])

    check_inputs()

    main(sys.argv)
